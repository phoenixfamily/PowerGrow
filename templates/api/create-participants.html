{% extends 'api/base.html' %}
{% load static %}
{% block title %}Ø´Ø±Ú©Øª Ú©Ù†Ù†Ø¯Ú¯Ø§Ù† | PowerGrow{% endblock %}

{% block header %}
    <div class="d-flex justify-content-end my-3 me-3">
        <a href="#" id="submit" class="btn btn-cta" target="_blank" rel="noopener noreferrer">Ø«Ø¨Øª Ù†Ø§Ù…</a>
    </div>
{% endblock %}


{% block content %}
    <div class="container py-5">
        <div class="card shadow rounded-4 p-4">
            <h4 class="fw-bold mb-4 text-center panel-form-h4">Ø§ÙØ²ÙˆØ¯Ù† Ø´Ø±Ú©Øªâ€Œ Ú©Ù†Ù†Ø¯Ù‡</h4>
            <form id="participant-form">
                <div class="row g-3">
                    <!-- Ø¹Ù†ÙˆØ§Ù† -->
                    <div class="col-md-6">
                        <label for="title" class="form-label fw-semibold">Ø¹Ù†ÙˆØ§Ù† Ø¯ÙˆØ±Ù‡</label>
                        <input type="text" class="form-control rounded-3" id="title" value="{{ course.title }}"
                               readonly>
                    </div>

                    <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª -->
                    <div class="col-md-6">
                        <label for="description" class="form-label fw-semibold">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                        <textarea class="form-control rounded-3" id="description" rows="3"></textarea>
                    </div>

                    <!-- ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ù‡ -->
                    <div class="col-md-6">
                        <label for="session" class="form-label fw-semibold">ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ù‡</label>
                        <select class="form-select rounded-3" id="session" required>
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            {% for x in course.sessions.all %}
                                <option dir="rtl" value="{{ x.id }}">{{ x.number }} Ø¬Ù„Ø³Ù‡</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ -->
                    <div class="col-md-6">
                        <label for="day" class="form-label fw-semibold">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡</label>
                        <select class="form-select rounded-3" id="day" required>
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            {% for x in days %}
                                <option dir="rtl" value="{{ x.id }}">{{ x.title }} | {{ x.session }} Ø¬Ù„Ø³Ù‡</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label fw-semibold">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
                        <div class="calendar-wrapper">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button id="prevMonth" class="btn btn-cta" aria-label="Ù…Ø§Ù‡ Ù‚Ø¨Ù„">
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                                <h5 id="monthTitle" class="text-center fw-bold m-0"></h5>
                                <button id="nextMonth" class="btn btn-cta" aria-label="Ù…Ø§Ù‡ Ø¨Ø¹Ø¯">
                                    <i class="fa fa-chevron-left"></i>
                                </button>
                            </div>

                            <div class="calendar-grid text-center fw-bold border-bottom pb-2">
                                <div>Ø´</div>
                                <div>ÛŒ</div>
                                <div>Ø¯</div>
                                <div>Ø³</div>
                                <div>Ú†</div>
                                <div>Ù¾</div>
                                <div>Ø¬</div>
                            </div>

                            <div id="calendarDays" class="calendar-grid mt-2">
                                <!-- Ø±ÙˆØ²Ù‡Ø§ Ø¨Ø§ JS Ù¾Ø± Ù…ÛŒØ´Ù‡ -->
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="startDay" name="startDay">


                    <!-- Ù‚ÛŒÙ…Øª -->
                    <div class="col-md-6">
                        <label for="price" class="form-label fw-semibold">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" class="form-control rounded-3" id="price" required>
                    </div>

                    <!-- Ú©Ø§Ø±Ø¨Ø± -->
                    <div class="col-md-12">
                        <label for="user" class="form-label fw-semibold">Ú©Ø§Ø±Ø¨Ø± (Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡)</label>
                        <input class="form-control rounded-3" dir="ltr" id="user" type="number" name="user"
                               placeholder="Ù…Ø«Ù„Ø§Ù‹: 9123456789" required>
                    </div>
                </div>

            </form>
        </div>
    </div>


    <script>
        // Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
        // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ API Ù‡Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ù„Ø³Ø§ØªØŒ Ø±ÙˆØ²Ù‡Ø§ Ùˆ Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†ÛŒ Ùˆ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒ
        // Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø«Ø§Ù„:
        document.addEventListener('DOMContentLoaded', function () {
            // Ù…Ø«Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
            const sessionSelect = document.getElementById('session');
            const daySelect = document.getElementById('day');
            // ...Ùˆ Ù‡Ù…ÛŒÙ†Ø·ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯ÛŒÚ¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§
        });

        // Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
        document.getElementById('submit').addEventListener('click', function (event) {
            event.preventDefault();
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ API
            const data = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                session: document.getElementById('session').value,
                day: document.getElementById('day').value,
                startDay: document.getElementById('startDay').value,
                price: document.getElementById('price').value,
                user: `+98${document.getElementById('user').value}`,
            };

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch('{% url 'product:manager-create-participation' course.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken, // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† CSRF token

                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!');
                        // ÙØ±Ù… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù† ÛŒØ§ Ø¨Ù‡ ØµÙØ­Ù‡ Ø¯ÛŒÚ¯Ø± Ø¨Ø±Ùˆ
                    } else {
                        return response.json().then(errorData => {
                            alert('Ø®Ø·Ø§: ' + JSON.stringify(errorData));
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>

    <script>

        async function getAllUser() {
            const userList = [];
            let phone;

            {% for x in user.all %}
                phone = "{{ x.number }}".replace("+98", "");
                userList.push(phone);
            {% endfor %}

            setupAutocomplete(document.getElementById("user"), userList);
        }

        function setupAutocomplete(input, arr) {
            let currentFocus = -1;

            input.addEventListener("input", function () {
                const val = this.value;
                closeAllLists();
                if (!val) return;

                // Ø§ÛŒØ¬Ø§Ø¯ div Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
                const autocompleteList = document.createElement("div");
                autocompleteList.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(autocompleteList); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ parent

                let hasResults = false; // Ù…ØªØºÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù†ØªØ§ÛŒØ¬

                arr.forEach(item => {
                    if (item.substr(0, val.length).toLowerCase() === val.toLowerCase()) {
                        hasResults = true; // Ø§Ú¯Ø± Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯
                        const itemDiv = document.createElement("div");
                        itemDiv.innerHTML = `<strong>${item.substr(0, val.length)}</strong>${item.substr(val.length)}`;
                        itemDiv.innerHTML += `<input type='hidden' value='${item}'>`;
                        itemDiv.addEventListener("click", function () {
                            input.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        autocompleteList.appendChild(itemDiv); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† itemDiv Ø¨Ù‡ autocompleteList
                    }
                });

                if (!hasResults) {
                    const noResultsDiv = document.createElement("div");
                    noResultsDiv.innerHTML = "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
                    autocompleteList.appendChild(noResultsDiv);
                }
            });

            input.addEventListener("keydown", function (e) {
                const items = document.querySelectorAll(".autocomplete-items div");
                if (items.length > 0) {
                    if (e.keyCode === 40) { // down
                        currentFocus++;
                        addActive(items);
                    } else if (e.keyCode === 38) { // up
                        currentFocus--;
                        addActive(items);
                    } else if (e.keyCode === 13) { // enter
                        e.preventDefault();
                        if (currentFocus > -1) items[currentFocus].click();
                    }
                }
            });

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });

            function closeAllLists(exceptElement) {
                const items = document.querySelectorAll(".autocomplete-items");
                items.forEach(item => {
                    item.parentNode.removeChild(item);
                });
            }

            function addActive(items) {
                if (!items) return;
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                items[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(items) {
                items.forEach(item => {
                    item.classList.remove("autocomplete-active");
                });
            }
        }

        // Run the getAllUser function when the document is fully loaded
        document.addEventListener("DOMContentLoaded", function () {
            getAllUser();
        });


    </script>

      <script>
        const apiBase = '/calendar'; // ÙØ±Ø¶ Ú©Ù† Ø¢Ø¯Ø±Ø³ API Ø§ÛŒÙ†Ù‡
        let currentMonthId = null;
        let currentDayId = null;


        function loadMonth(monthId) {
            fetch(`${apiBase}/months/${monthId}/`)
                .then(res => res.json())
                .then(month => {
                    currentMonthId = month.id;
                    document.getElementById("monthTitle").innerText = `${month.name} ${month.year.number}`;

                    const daysContainer = document.getElementById("calendarDays");
                    daysContainer.innerHTML = "";

                    const startIndex = month.start_weekday; // 0=Ø´Ù†Ø¨Ù‡ ... 6=Ø¬Ù…Ø¹Ù‡

                    console.log(startIndex)

                    for (let i = 0; i < startIndex; i++) {
                            daysContainer.innerHTML += `<div class="col calendar-day empty disabled"></div>`;

                    }

                    month.days.forEach(day => {
                        const classes = ["calendar-day"];
                        if (day.holiday) classes.push("holiday");
                        if (day.today) classes.push("today");

                        daysContainer.innerHTML += `
      <div class="${classes.join(" ")}" data-id="${day.id}" title="${day.description || ''}">
        ${day.number}
      </div>`;
                    });

                });
        }

        // Navigation
        document.getElementById("prevMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/prev/`).then(res => res.json()).then(m => loadMonth(m.id));
        });
        document.getElementById("nextMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/next/`).then(res => res.json()).then(m => loadMonth(m.id));
        });

        // First load
        window.onload = () => {
            fetch(`${apiBase}/months/current/`).then(res => res.json()).then(m => loadMonth(m.id));
        };


        document.addEventListener('click', function (e) {
            const dayEl = e.target.closest('.calendar-day');
            if (dayEl) {
                // Ø§ÙˆÙ„ Ù‡Ù…Ù‡ Ø±ÙˆØ²Ù‡Ø§ Ø§Ø² Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¯Ø±Ù…ÛŒØ§Ø¯
                document.querySelectorAll('.calendar-day').forEach(el => {
                    el.classList.remove('selected-day');
                });

                // ÙÙ‚Ø· Ù‡Ù…ÙˆÙ†ÛŒ Ú©Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒØ´Ù‡
                dayEl.classList.add('selected-day');
            }
        });

        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("calendar-day") && !e.target.classList.contains("holiday") && !e.target.classList.contains("past")) {
                document.querySelectorAll(".calendar-day").forEach(d => d.classList.remove("selected-day"));
                e.target.classList.add("selected-day");

                currentDayId = e.target.getAttribute("data-id");  // âœ… Ø¢ÛŒØ¯ÛŒ Ø±ÙˆØ² ØªÙ‚ÙˆÛŒÙ…
            }
        });

        document.addEventListener("click", function (e) {
    if (e.target.classList.contains("calendar-day") && !e.target.classList.contains("holiday") && !e.target.classList.contains("past")) {
        document.querySelectorAll(".calendar-day").forEach(d => d.classList.remove("selected-day"));
        e.target.classList.add("selected-day");

        currentDayId = e.target.getAttribute("data-id");
        document.getElementById("startDay").value = currentDayId; // ğŸ‘ˆ Ø³Øª Ø¨Ù‡ input hidden
    }
});



    </script>
uyyyyyyyyy

{% endblock %}