{% extends 'api/base.html' %}
{% load static %}
{% block title %}Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø±Ú©Øª Ú©Ù†Ù†Ø¯Ù‡ | PowerGrow{% endblock %}



{% block header %}
    <div class="d-flex justify-content-end my-3 me-3">
        <a href="#" id="submit" class="btn btn-cta">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</a>
    </div>
{% endblock %}


{% block content %}


    <div class="container py-5">
        <div class="card shadow rounded-4 p-4">
            <h4 class="fw-bold mb-4 text-center panel-form-h4">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</h4>
            <form id="update-participant-form">
                <div class="row g-3">
                    <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª -->
                    <div class="col-12">
                        <label for="description" class="form-label fw-semibold">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                        <textarea class="form-control rounded-3" id="description" rows="3"
                                  required>{{ participant.description }}</textarea>
                    </div>

                    <!-- ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ù‡ -->
                    <div class="col-md-6">
                        <label for="session" class="form-label fw-semibold">ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ù‡</label>
                        <select class="form-select rounded-3" id="session" required>
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            {% for x in session %}
                                <option value="{{ x.id }}" {% if x.id == participant.session.id %}selected{% endif %}>
                                    {{ x.number }} Ø¬Ù„Ø³Ù‡
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ø±ÙˆØ² Ù‡ÙØªÙ‡ -->
                    <div class="col-md-6">
                        <label for="day" class="form-label fw-semibold">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡</label>
                        <select class="form-select rounded-3" id="day" required>
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            {% for x in days %}
                                <option value="{{ x.id }}" {% if x.id == participant.day.id %}selected{% endif %}>
                                    {{ x.title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
                        <div id="startDay-wrapper" class="calendar-wrapper">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-cta prevMonth"><i class="fa fa-chevron-right"></i></button>
                                <h5 class="text-center fw-bold m-0 monthTitle"></h5>
                                <button class="btn btn-cta nextMonth"><i class="fa fa-chevron-left"></i></button>
                            </div>

                            <div class="calendar-grid text-center fw-bold border-bottom pb-2">
                                <div>Ø´</div>
                                <div>ÛŒ</div>
                                <div>Ø¯</div>
                                <div>Ø³</div>
                                <div>Ú†</div>
                                <div>Ù¾</div>
                                <div>Ø¬</div>
                            </div>

                            <div class="calendar-grid mt-2 calendarDays"></div>
                        </div>
                        <input type="hidden" id="startDay" name="startDay"
                               value="{{ participant.startDay.id}}"
                               data-month-id="{{ participant.startDay.month.id}}">
                    </div>

                    <!-- ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label>
                        <div id="endDay-wrapper" class="calendar-wrapper">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-cta prevMonth"><i class="fa fa-chevron-right"></i></button>
                                <h5 class="text-center fw-bold m-0 monthTitle"></h5>
                                <button class="btn btn-cta nextMonth"><i class="fa fa-chevron-left"></i></button>
                            </div>

                            <div class="calendar-grid text-center fw-bold border-bottom pb-2">
                                <div>Ø´</div>
                                <div>ÛŒ</div>
                                <div>Ø¯</div>
                                <div>Ø³</div>
                                <div>Ú†</div>
                                <div>Ù¾</div>
                                <div>Ø¬</div>
                            </div>

                            <div class="calendar-grid mt-2 calendarDays"></div>
                        </div>

                        <input type="hidden" id="endDay" name="endDay"
                               value="{{ participant.endDay.id}}"
                               data-month-id="{{ participant.endDay.month.id}}">

                    </div>

                    <!-- Ù‚ÛŒÙ…Øª -->
                    <div class="col-md-6">
                        <label for="price" class="form-label fw-semibold">Ù‚ÛŒÙ…Øª</label>
                        <input type="number" class="form-control rounded-3" id="price" value="{{ participant.price }}"
                               required>
                    </div>

                    <!-- Ø¯ÙˆØ±Ù‡ -->
                    <div class="col-md-6">
                        <label for="course" class="form-label fw-semibold">Ø¯ÙˆØ±Ù‡</label>
                        <select class="form-select rounded-3" id="course" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            {% for x in course %}
                                <option value="{{ x.id }}" {% if x.id == participant.course.id %}selected{% endif %}>
                                    {{ x.title }} - {{ x.id }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ú©Ø§Ø±Ø¨Ø± -->
                    <div class="col-12">
                        <label for="user" class="form-label fw-semibold">Ú©Ø§Ø±Ø¨Ø± (Ù…ÙˆØ¨Ø§ÛŒÙ„)</label>
                        <input type="number" class="form-control rounded-3" dir="ltr" id="user" name="user" required>
                    </div>
                </div>

            </form>
        </div>
    </div>



    <script>
        document.getElementById('submit').addEventListener('click', function (event) {
            event.preventDefault();

            const userId = parseInt(document.getElementById('user').dataset.userId)

            const data = {
                description: document.getElementById('description').value,
                session: parseInt(document.getElementById('session').value),
                day: parseInt(document.getElementById('day').value),
                startDay: parseInt(document.getElementById('startDay').value),
                endDay: parseInt(document.getElementById('endDay').value),
                course: parseInt(document.getElementById('course').value),
                price: parseInt(document.getElementById('price').value),
                user: userId,
            };

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch(`{% url 'product:manager-update-participation' participant.id %}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯!');
                        // Ø¨Ù‡ ØµÙØ­Ù‡ Ø¯ÛŒÚ¯Ø± Ø¨Ø±Ùˆ ÛŒØ§ ÙØ±Ù… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†
                    } else {
                        return response.json().then(errorData => {
                            alert('Ø®Ø·Ø§: ' + JSON.stringify(errorData));
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>

    <script>
        async function getAllUser() {
            const userList = [];
            const userHolder = document.getElementById("user");

            // Ø´Ù…Ø§Ø±Ù‡â€ŒÛŒ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø¯Ø§Ø®Ù„ input
            userHolder.value = "{{ participant.user.number }}".replace("+98", "");
            userHolder.dataset.userId = "{{ participant.user.id }}"; // ğŸ‘ˆ Ù‡Ù…ÛŒÙ†Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†!


            {% for x in user.all %}
                userList.push({
                    id: {{ x.id }},
                    phone: "{{ x.number }}".replace("+98", "")
                });
            {% endfor %}

            setupAutocomplete(userHolder, userList);
        }

        function setupAutocomplete(input, arr) {

            input.addEventListener("input", function () {
                const val = this.value;
                closeAllLists();
                if (!val) return;

                const autocompleteList = document.createElement("div");
                autocompleteList.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(autocompleteList);

                let hasResults = false;

                arr.forEach(item => {
                    if (item.phone.substr(0, val.length) === val) {
                        hasResults = true;
                        const itemDiv = document.createElement("div");
                        itemDiv.innerHTML = `<strong>${item.phone.substr(0, val.length)}</strong>${item.phone.substr(val.length)}`;
                        itemDiv.dataset.id = item.id; // Ø§ÛŒÙ†Ø¬Ø§ id Ø¯Ø±Ø³Øª Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡
                        itemDiv.addEventListener("click", function () {
                            input.value = item.phone;
                            input.dataset.userId = item.id; // id ØªÙˆ input Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡
                            closeAllLists();
                        });
                        autocompleteList.appendChild(itemDiv);
                    }
                });

                if (!hasResults) {
                    const noResultsDiv = document.createElement("div");
                    noResultsDiv.innerHTML = "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
                    autocompleteList.appendChild(noResultsDiv);
                }
            });

            function closeAllLists() {
                const items = document.querySelectorAll(".autocomplete-items");
                items.forEach(item => item.parentNode.removeChild(item));
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            getAllUser();
        });
    </script>

    <script>
        function initCalendar(wrapperSelector, hiddenInputSelector) {
            const wrapper = document.querySelector(wrapperSelector);
            const inputHidden = document.querySelector(hiddenInputSelector);
            let currentMonthId = inputHidden.dataset.monthId || null;
            let currentDayId = inputHidden.value || null;

            const monthTitle = wrapper.querySelector('.monthTitle');
            const daysContainer = wrapper.querySelector('.calendarDays');
            const prevBtn = wrapper.querySelector('.prevMonth');
            const nextBtn = wrapper.querySelector('.nextMonth');

            function loadMonth(monthId) {
                fetch(`/calendar/months/${monthId}/`)
                    .then(res => res.json())
                    .then(month => {
                        currentMonthId = month.id;
                        monthTitle.innerText = `${month.name} ${month.year.number}`;
                        daysContainer.innerHTML = "";

                        for (let i = 0; i < month.start_weekday; i++) {
                            daysContainer.innerHTML += `<div class="col calendar-day empty disabled"></div>`;
                        }

                        month.days.forEach(day => {
                            const classes = ["calendar-day"];
                            if (day.holiday) classes.push("holiday");
                            if (day.today) classes.push("today");
                            if (day.id === currentDayId) classes.push("selected-day");

                            daysContainer.innerHTML += `
                            <div class="${classes.join(" ")}"
                                 data-id="${day.id}"
                                 title="${day.description || ''}">
                                ${day.number}
                            </div>`;
                        });
                    });
            }

            prevBtn.addEventListener("click", () => {
                fetch(`/calendar/months/${currentMonthId}/prev/`)
                    .then(res => res.json())
                    .then(m => loadMonth(m.id));
            });

            nextBtn.addEventListener("click", () => {
                fetch(`/calendar/months/${currentMonthId}/next/`)
                    .then(res => res.json())
                    .then(m => loadMonth(m.id));
            });

            daysContainer.addEventListener("click", function (e) {
                const dayEl = e.target.closest(".calendar-day");
                if (!dayEl || dayEl.classList.contains("holiday") || dayEl.classList.contains("past")) return;

                daysContainer.querySelectorAll(".calendar-day").forEach(d => d.classList.remove("selected-day"));
                dayEl.classList.add("selected-day");

                currentDayId = dayEl.getAttribute("data-id");
                inputHidden.value = currentDayId;
                inputHidden.dataset.monthId = currentMonthId; // Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ† Ù…Ø§Ù‡
            });

            // Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡
            if (currentMonthId) {
                loadMonth(currentMonthId); // Ø§Ú¯Ø± Ù…Ø§Ù‡ Ø§Ø² Ù‚Ø¨Ù„ Ø¯Ø§Ø±ÛŒÙ…ØŒ Ù‡Ù…ÙˆÙ† Ø±Ùˆ Ù„ÙˆØ¯ Ú©Ù†
            } else {
                fetch(`/calendar/months/current/`)
                    .then(res => res.json())
                    .then(m => loadMonth(m.id));
            }
        }

        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ startDay Ùˆ endDay
        initCalendar('#startDay-wrapper', '#startDay');
        initCalendar('#endDay-wrapper', '#endDay');
    </script>


{% endblock %}