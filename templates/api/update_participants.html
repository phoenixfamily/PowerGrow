{% extends 'api/base.html' %}
{% load static %}
{% block title %}بروزرسانی شرکت کننده | PowerGrow{% endblock %}



{% block header %}
    <div class="d-flex justify-content-end my-3 me-3">
        <a href="#" id="submit" class="btn btn-cta">بروزرسانی</a>
    </div>
{% endblock %}


{% block content %}

    <
    <div class="container py-5">
        <div class="card shadow rounded-4 p-4">
            <h4 class="fw-bold mb-4 text-center panel-form-h4">ویرایش اطلاعات شرکت‌کننده</h4>
            <form id="update-participant-form">
                <div class="row g-3">
                    <!-- توضیحات -->
                    <div class="col-12">
                        <label for="description" class="form-label fw-semibold">توضیحات</label>
                        <textarea class="form-control rounded-3" id="description" rows="3"
                                  required>{{ participant.description }}</textarea>
                    </div>

                    <!-- تعداد جلسه -->
                    <div class="col-md-6">
                        <label for="session" class="form-label fw-semibold">تعداد جلسه</label>
                        <select class="form-select rounded-3" id="session" required>
                            <option value="" disabled selected>انتخاب کنید</option>
                            {% for x in session %}
                                <option value="{{ x.id }}" {% if x.id == participant.session.id %}selected{% endif %}>
                                    {{ x.number }} جلسه
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- روز هفته -->
                    <div class="col-md-6">
                        <label for="day" class="form-label fw-semibold">روزهای هفته</label>
                        <select class="form-select rounded-3" id="day" required>
                            <option value="" disabled selected>انتخاب کنید</option>
                            {% for x in days %}
                                <option value="{{ x.id }}" {% if x.id == participant.day.id %}selected{% endif %}>
                                    {{ x.title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- تاریخ شروع -->
                    <div class="col-md-6">
                        <label for="startDay" class="form-label fw-semibold">تاریخ شروع</label>
                        <select class="form-select rounded-3" id="startDay" required>
                            <option value="">انتخاب کنید</option>
                            {% for x in day %}
                                <option value="{{ x.id }}" {% if x.id == participant.startDay.id %}selected{% endif %}>
                                    {{ x.name }} {{ x.month.year.number }}/{{ x.month.number }}/{{ x.number }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- تاریخ پایان -->
                    <div class="col-md-6">
                        <label for="endDay" class="form-label fw-semibold">تاریخ پایان</label>
                        <select class="form-select rounded-3" id="endDay" required>
                            <option value="">انتخاب کنید</option>
                            {% for x in day %}
                                <option value="{{ x.id }}" {% if x.id == participant.endDay.id %}selected{% endif %}>
                                    {{ x.name }} {{ x.month.year.number }}/{{ x.month.number }}/{{ x.number }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- قیمت -->
                    <div class="col-md-6">
                        <label for="price" class="form-label fw-semibold">قیمت</label>
                        <input type="number" class="form-control rounded-3" id="price" value="{{ participant.price }}"
                               required>
                    </div>

                    <!-- دوره -->
                    <div class="col-md-6">
                        <label for="course" class="form-label fw-semibold">دوره</label>
                        <select class="form-select rounded-3" id="course" required>
                            <option value="">انتخاب کنید</option>
                            {% for x in course %}
                                <option value="{{ x.id }}" {% if x.id == participant.course.id %}selected{% endif %}>
                                    {{ x.title }} - {{ x.id }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- کاربر -->
                    <div class="col-12">
                        <label for="user" class="form-label fw-semibold">کاربر (موبایل)</label>
                        <input type="number" class="form-control rounded-3" dir="ltr" id="user" name="user" required>
                    </div>
                </div>

            </form>
        </div>
    </div>


<script>
async function getAllUser() {
    const userList = [];
    const userHolder = document.getElementById("user")
    userHolder.value = "{{ participant.user.number|slice:'3:' }}"  // حذف +98

    {% for x in user.all %}
        userList.push({
            number: "{{ x.number|slice:'3:' }}",
            id: {{ x.id }}
        });
    {% endfor %}

    setupAutocomplete(userHolder, userList);
}

function setupAutocomplete(input, arr) {
    let currentFocus = -1;

    input.addEventListener("input", function () {
        const val = this.value;
        closeAllLists();
        if (!val) return;

        const autocompleteList = document.createElement("div");
        autocompleteList.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(autocompleteList);

        arr.forEach(item => {
            if (item.number.substr(0, val.length) === val) {
                const itemDiv = document.createElement("div");
                itemDiv.innerHTML = `<strong>${item.number.substr(0, val.length)}</strong>${item.number.substr(val.length)}`;
                itemDiv.dataset.userId = item.id;  // اینجا id واقعی رو ذخیره میکنیم
                itemDiv.addEventListener("click", function () {
                    input.value = item.number;
                    input.dataset.userId = item.id; // ذخیره id واقعی برای ارسال
                    closeAllLists();
                });
                autocompleteList.appendChild(itemDiv);
            }
        });
    });

    function closeAllLists() {
        const items = document.querySelectorAll(".autocomplete-items");
        items.forEach(item => item.parentNode.removeChild(item));
    }
}

document.addEventListener("DOMContentLoaded", function () {
    getAllUser();
});

document.getElementById('submit').addEventListener('click', function (event) {
    event.preventDefault();
    const userId = parseInt(document.getElementById('user').dataset.userId); // integer واقعی

    const data = {
        description: document.getElementById('description').value,
        session: parseInt(document.getElementById('session').value),
        day: parseInt(document.getElementById('day').value),
        startDay: parseInt(document.getElementById('startDay').value),
        endDay: parseInt(document.getElementById('endDay').value),
        course: parseInt(document.getElementById('course').value),
        price: parseInt(document.getElementById('price').value),
        user: userId,
    };

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`{% url 'product:manager-update-participation' participant.id %}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            alert('اطلاعات با موفقیت به‌روزرسانی شد!');
        } else {
            return response.json().then(errorData => {
                alert('خطا: ' + JSON.stringify(errorData));
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});
</script>


{% endblock %}