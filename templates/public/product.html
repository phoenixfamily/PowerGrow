{% extends 'public/base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    {% block title %}دوره {{ product.title }} باشگاه ورزشی حجاب {% endblock %}
</head>
<body>

{% block header %}
    <!-- آیتم‌های منو -->
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'home:home-view' %}">خانه</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'product:sport-view' %}">دوره ها</a>
            </li>

            <li class="nav-item">
                <a class="nav-link disabled" href="{% url 'reservation:reservation-view' %}">رزرو سالن</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'about:about-view' %}">درباره ما</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'user:login' %}">ورود و عضویت</a>
            </li>
        </ul>
    </div>
{% endblock %}



{% block content %}
    <section class="hero-split py-5">
        <div class="container-fluid px-lg-5">
            <div class="row g-5 align-items-stretch">

                <!-- متن سمت راست -->
                <div class="col-lg-6 d-flex">
                    <div class="ground-box text-white rounded p-4 w-100 d-flex flex-column justify-content-center">
                        <h2 class="fw-bold mb-4">{{ product.title }}</h2>

                        <div class="d-flex flex-column gap-4">

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-calendar-check fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">نوع دوره</h5>
                                    <p class="mb-0 small text-white ">
                                        {% if product.type == "public" %}
                                            عمومی
                                        {% elif product.type == "private" %}
                                            خصوصی
                                        {% elif product.type == "semi_private" %}
                                            نیمه خصوصی
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-clock fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">زمان دوره</h5>
                                    <p class="mb-0 small text-white ">{{ product.time }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-calendar-check fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">جنسبت دوره</h5>
                                    <p class="mb-0 small text-white ">
                                        {% if product.gender == "male" %}
                                            آقایان
                                        {% elif product.gender == "female" %}
                                            بانوان
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-user-tie fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">مربی</h5>
                                    <p class="mb-0 small text-white ">{{ product.name }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-users fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">ظرفیت باقی‌مانده</h5>
                                    <p class="mb-0 small text-white ">3 نفر</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-money-bill-wave fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">شهریه</h5>
                                    <p class="mb-0 small text-white ">-</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- عکس سمت چپ -->
                <div class="col-lg-6 d-flex">
                    <div class="img-wrapper w-100 d-flex align-items-center justify-content-center">
                        <img src="{% static 'images/hero.png' %}" alt="باشگاه بانوان" class="img-fluid rounded shadow">
                    </div>
                </div>

            </div>
        </div>
    </section>

    <section class="hero-split py-5">
        <div class="container-fluid px-lg-5">
            <div class="course-schedule-form bg-white p-4 rounded shadow-sm">
                <h4 class="fw-bold mb-4">ثبت نام دوره</h4>

                <!-- انتخاب روزهای هفته -->
                <div class="mb-3">
                    <label class="form-label fw-bold">روزهای برگزاری:</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for x in days %}
                            <button type="button"
                                    class="btn day-btn rounded-pill px-3">{{ x.title }}</button>
                        {% endfor %}
                    </div>
                </div>

                <!-- تعداد جلسات -->
                <div class="mb-3">
                    <label class="form-label fw-bold">تعداد جلسات در ماه:</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for x in session %}
                            <button type="button"
                                    class="btn session-btn rounded-pill px-3">{{ x.number }} جلسه
                            </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- تاریخ شروع -->
                <div class="mb-3">
                    <label for="start-date" class="form-label fw-bold">تاریخ شروع:</label>

                    <div class="calendar-wrapper mx-auto">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prevMonth" class="btn btn-outline-secondary"><i class="fa fa-chevron-right"></i>
                            </button>
                            <h5 id="monthTitle" class="text-center fw-bold m-0"></h5>
                            <button id="nextMonth" class="btn btn-outline-secondary"><i class="fa fa-chevron-left"></i>
                            </button>
                        </div>

                        <!-- سرتیتر ایام هفته -->
                        <div class="calendar-grid text-center fw-bold border-bottom pb-2">
                            <div>ش</div>
                            <div>ی</div>
                            <div>د</div>
                            <div>س</div>
                            <div>چ</div>
                            <div>پ</div>
                            <div>ج</div>
                        </div>

                        <!-- روزهای ماه -->
                        <div id="calendarDays" class="calendar-grid mt-2">
                            <!-- لود میشه از JS -->
                        </div>
                    </div>


                </div>

            </div>
        </div>

    </section>

    <script>
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // غیرفعال کردن همه دکمه‌ها
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));

                // فعال کردن فقط دکمه کلیک‌شده
                btn.classList.add('active');
            });
        });
    </script>


    <script>
        document.querySelectorAll('.session-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // غیرفعال کردن همه دکمه‌ها
                document.querySelectorAll('.session-btn').forEach(b => b.classList.remove('active'));

                // فعال کردن فقط دکمه کلیک‌شده
                btn.classList.add('active');
            });
        });
    </script>

    <script>
        const apiBase = '/calendar'; // فرض کن آدرس API اینه
        let currentMonthId = null;

        function loadMonth(monthId) {
            fetch(`${apiBase}/months/${monthId}/`)
                .then(res => res.json())
                .then(month => {
                    currentMonthId = month.id;
                    document.getElementById("monthTitle").innerText = `${month.name} ${month.year.number}`;

                    const daysContainer = document.getElementById("calendarDays");
                    daysContainer.innerHTML = "";

                    // اضافه کردن روزهای خالی اول ماه
                    const dayNames = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه ‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'];
                    const startIndex = dayNames.indexOf(month.startDay);
                    for (let i = 0; i < startIndex; i++) {
                        daysContainer.innerHTML += `<div class="col calendar-day"></div>`;
                    }

                    month.days.forEach(day => {
                        const classes = ["calendar-day"];
                        if (day.holiday) classes.push("holiday");
                        if (day.today) classes.push("today");

                        daysContainer.innerHTML += `
      <div class="${classes.join(" ")}" title="${day.description || ''}">
        ${day.number}
      </div>`;
                    });

                });

            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.addEventListener('click', () => {
                    // پاک‌کردن انتخاب قبلی
                    document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected-day'));
                    // فعال کردن جدید
                    dayEl.classList.add('selected-day');
                });
            });

        }

        // Navigation
        document.getElementById("prevMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/prev/`).then(res => res.json()).then(m => loadMonth(m.id));
        });
        document.getElementById("nextMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/next/`).then(res => res.json()).then(m => loadMonth(m.id));
        });

        // First load
        window.onload = () => {
            fetch(`${apiBase}/months/current/`).then(res => res.json()).then(m => loadMonth(m.id));
        };

    </script>


{% endblock %}


</body>
</html>


<script>

    let calendar = document.getElementById("calendar")
    let monthTitle = document.getElementById("monthTitle")
    let yearTitle = document.getElementById("yearTitle")
    let prev = document.getElementById("next")
    let next = document.getElementById("prev")
    let days = document.getElementById("days")
    let result
    let monthSize
    let date
    let startDay = document.getElementById("startDay")
    let currentDayId
    let today = new Date().toLocaleDateString('fa-IR');
    today = today.split('/')
    let currentDay = today[2].replace(/[۰-۹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728))
    let currentMonth = today[1].replace(/[۰-۹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728))
    let currentYear = today[0].replace(/[۰-۹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728))
    let thisYear = today[0].replace(/[۰-۹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728))
    let monthPosition = currentMonth - 1


    document.addEventListener("DOMContentLoaded", function () {
        getYear()

        console.log(currentYear)
        console.log(thisYear)

    });

    next.addEventListener("click", function () {
        if (monthPosition > 0) {
            monthPosition = monthPosition - 1
            getDays(monthPosition)
        } else if (monthPosition === 0) {
            if (currentYear > 1402) {
                currentYear = parseInt(currentYear) - 1
                getYear(currentYear)
            }
        }
    })

    prev.addEventListener("click", function () {
        if (monthPosition < monthSize - 1) {
            monthPosition = monthPosition + 1
            getDays(monthPosition)
        } else if (monthPosition === monthSize - 1) {
            if (currentYear < 1404) {
                currentYear = parseInt(currentYear) + 1
                getYear(currentYear)
            }
        }
    })

    async function getYear() {
        const response = await fetch(`/calendar/api/year/${currentYear}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        result = await response.json();
        result = JSON.parse(JSON.stringify(result));
        monthSize = result[0].months.length;

        yearTitle.innerHTML = result[0].number;

        if (parseInt(currentYear) < parseInt(thisYear)) {  // اگر سال قبل از سال جاری است، آخرین ماه نمایش داده شود
            monthPosition = monthSize - 1;
        } else if (parseInt(currentYear) === parseInt(thisYear)) { // اگر سال جاری است، ماه فعلی نمایش داده شود
            monthPosition = currentMonth - 1;
        } else { // اگر سال آینده است، اولین ماه نمایش داده شود
            monthPosition = 0;
        }

        getDays(monthPosition);
    }

    function getDays(monthPosition) {
        monthTitle.innerHTML = result[0].months[monthPosition].name;
        days.innerHTML = "";
        startDay.innerHTML = "";

        const emptyDay = document.createElement("li");
        emptyDay.innerHTML = ' ';

        switch (result[0].months[monthPosition].startDay) {

            case "یکشنبه" :
                const empty0 = document.createElement("li")
                days.appendChild(empty0)
                break
            case "دوشنبه" :
                const empty1 = document.createElement("li")
                days.appendChild(empty1)
                const empty2 = document.createElement("li")
                days.appendChild(empty2)
                break

            case "سه شنبه" :
                const empty3 = document.createElement("li")
                days.appendChild(empty3)
                const empty4 = document.createElement("li")
                days.appendChild(empty4)
                const empty5 = document.createElement("li")
                days.appendChild(empty5)
                break
            case "چهارشنبه" :
                const empty6 = document.createElement("li")
                days.appendChild(empty6)
                const empty7 = document.createElement("li")
                days.appendChild(empty7)
                const empty9 = document.createElement("li")
                days.appendChild(empty9)
                const empty10 = document.createElement("li")
                days.appendChild(empty10)

                break
            case "پنجشنبه" :
                const empty11 = document.createElement("li")
                days.appendChild(empty11)
                const empty12 = document.createElement("li")
                days.appendChild(empty12)
                const empty13 = document.createElement("li")
                days.appendChild(empty13)
                const empty14 = document.createElement("li")
                days.appendChild(empty14)
                const empty15 = document.createElement("li")
                days.appendChild(empty15)
                break
            case "جمعه" :
                const empty16 = document.createElement("li")
                days.appendChild(empty16)
                const empty17 = document.createElement("li")
                days.appendChild(empty17)
                const empty18 = document.createElement("li")
                days.appendChild(empty18)
                const empty19 = document.createElement("li")
                days.appendChild(empty19)
                const empty20 = document.createElement("li")
                days.appendChild(empty20)
                const empty21 = document.createElement("li")
                days.appendChild(empty21)
                break
        }

        for (let i = 0; i < result[0].months[monthPosition].days.length; i++) {
            const dayItem = document.createElement("li");
            const dayNumber = result[0].months[monthPosition].days[i].number;
            const monthNumber = result[0].months[monthPosition].number;
            const yearNumber = result[0].number;

            if (result[0].months[monthPosition].days[i].holiday === true && dayNumber > parseInt(currentDay)) {

                {% if product.previous %}
                    dayItem.classList.add("disActiveButton");
                {% else %}
                    dayItem.classList.add("holidayButton");
                {% endif %}

            } else if (yearNumber === parseInt(thisYear) && monthNumber === parseInt(currentMonth) && dayNumber === parseInt(currentDay)) {
                // روز جاری را مشخص کنیم
                dayItem.classList.add("activeButton");
                currentDayId = result[0].months[monthPosition].days[i].id;
                startDay.innerHTML = `${yearNumber}/${monthNumber}/${dayNumber}`;
                date = `${yearNumber}-${monthNumber}-${dayNumber}`;
            } else if (
                (yearNumber < parseInt(thisYear)) || // فقط سال‌های گذشته غیرفعال شود
                (yearNumber === parseInt(thisYear) && monthNumber < parseInt(currentMonth)) || // فقط ماه‌های گذشته غیر فعال شود
                (yearNumber === parseInt(thisYear) && monthNumber === parseInt(currentMonth) && dayNumber < parseInt(currentDay)) // روزهای گذشته در همان ماه غیر فعال شوند
            ) {
                dayItem.classList.add("disActiveButton");
            } else {

                {% if product.previous %}
                    dayItem.classList.add("disActiveButton");
                {% endif %}
            }

            dayItem.innerHTML = dayNumber;
            dayItem.setAttribute("itemid", result[0].months[monthPosition].days[i].id);
            days.appendChild(dayItem);
        }

        const buttons = document.querySelectorAll('.days li');
        Array.from(buttons).forEach(function (button) {
            button.addEventListener('click', async function () {
                const selected = document.querySelectorAll('.activeButton')
                Array.from(selected).forEach(function (btn) {
                    btn.classList.remove("activeButton")
                })
                button.classList.add("activeButton")
                currentDayId = button.getAttribute("itemid")
                startDay.innerHTML = `${result[0].number}/${result[0].months[monthPosition].number}/${button.textContent}`
                date = `${result[0].number}-${result[0].months[monthPosition].number}-${button.textContent}`

            })
        })
    }

</script>


{##}
{##}
{#<script>#}
{##}
{#    let counter = 0#}
{#    let capacity = "{{product.capacity}}";#}
{#    let course = "{{ product.id }}";#}
{#    let isEnable = ("{{ product.active }}"?.toLowerCase?.() === 'true');#}
{#    const card = document.getElementById("card")#}
{#    const capacityNumber = document.getElementById("number")#}
{#    const registerButton = document.getElementById("registerButton")#}
{#    let final_price#}
{##}
{#    let year = parseInt(today[0].replace(/[۰-۹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728)))#}
{#    let month = parseInt(today[1].replace(/[۰-۹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728)))#}
{#    let monthDay = parseInt(today[2].replace(/[۰-۹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728)))#}
{##}
{#    const thisDate = jalaali.j2d(year, month, monthDay)#}
{##}
{##}
{#    {% for x in participants.all %}#}
{##}
{#        var userEndYear = parseInt("{{ x.endDay.month.year.number }}");#}
{#        var userEndMonth = parseInt("{{ x.endDay.month.number }}");#}
{#        var userEndDay = parseInt("{{ x.endDay.number }}");#}
{##}
{#        var userEnd = jalaali.j2d(userEndYear, userEndMonth, userEndDay)#}
{##}
{#        if (0 < userEnd) {#}
{#            if (userEnd >= thisDate) {#}
{#                counter = counter + 1#}
{#            }#}
{#        }#}
{##}
{#    {% endfor %}#}
{##}
{##}
{#    capacityNumber.innerHTML = `${counter}/${parseInt(capacity)}`#}
{##}
{##}
{#    if (isEnable === true) {#}
{#        if (parseInt(counter) < parseInt(capacity)) {#}
{#            registerButton.disabled = false;#}
{#            {% if product.previous %}#}
{#                registerButton.innerHTML = "پیش ثبت نام";#}
{#            {% else %}#}
{#                registerButton.innerHTML = "ثبت نام کنید";#}
{#            {% endif %}#}
{#        } else {#}
{#            registerButton.disabled = true;#}
{#            registerButton.innerHTML = "ظرفیت تکمیل است";#}
{#        }#}
{#    } else {#}
{#        registerButton.disabled = true;#}
{#        registerButton.innerHTML = "دوره منقضی شده است";#}
{#    }#}
{##}
{#    card.appendChild(registerButton)#}
{##}
{#    registerButton.addEventListener('click', function () {#}
{##}
{#        if (sessionId !== 0 && dayId !== 0) {#}
{#            window.location.assign(`/product/payment/${course}/${sessionId}/${dayId}/${currentDayId}`)#}
{#        } else if (sessionId === 0) {#}
{#            alert("لطفا اول جلسه را انتخاب کنید")#}
{#        } else if (dayId === 0) {#}
{#            alert("لطفا روز را انتخاب کنید")#}
{#        } else {#}
{#            alert("تمامی موارد الزامی است")#}
{#        }#}
{##}
{#    })#}
{##}
{#</script>#}
