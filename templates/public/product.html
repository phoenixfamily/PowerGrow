{% extends 'public/base.html' %}
{% load static %}

{% block title %}{{ product.title }} | PowerGrow{% endblock %}


{% block content %}
    <section class="hero-split py-5">
        <div class="container-fluid px-lg-5">
            <div class="row g-5 align-items-stretch">

                <!-- متن سمت راست -->
                <div class="col-lg-6 d-flex">
                    <div class="ground-box text-white rounded p-4 w-100 d-flex flex-column justify-content-center">
                        <h2 class="fw-bold mb-4">{{ product.title }}</h2>

                        <div class="d-flex flex-column gap-4">

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-calendar-check fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">نوع دوره</h5>
                                    <p class="mb-0 small text-white ">
                                        {% if product.type == "public" %}
                                            عمومی
                                        {% elif product.type == "private" %}
                                            خصوصی
                                        {% elif product.type == "semi_private" %}
                                            نیمه خصوصی
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-clock fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">زمان دوره</h5>
                                    <p class="mb-0 small text-white ">{{ product.time }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-calendar-check fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">جنسبت دوره</h5>
                                    <p class="mb-0 small text-white ">
                                        {% if product.gender == "male" %}
                                            آقایان
                                        {% elif product.gender == "female" %}
                                            بانوان
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-user-tie fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">مربی</h5>
                                    <p class="mb-0 small text-white ">{{ product.name }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-users fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">ظرفیت دوره</h5>
                                    <p class="mb-0 small text-white ">{{ product.capacity }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-money-bill-wave fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">شهریه</h5>
                                    <p class="mb-0 small text-white ">-</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- عکس سمت چپ -->
                <div class="col-lg-6 d-flex">
                    <div class="img-wrapper w-100 d-flex align-items-center justify-content-center position-relative">
                        {% if product.previous %}
                            <div class="ribbon"><span class="bg-success">پیش ثبت ‌نام</span></div>
                        {% elif product.is_full %}
                            <div class="ribbon"><span class="bg-danger">تکمیل ظرفیت</span></div>
                        {% endif %}
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="باشگاه بانوان" class="img-fluid rounded shadow">
                        {% else %}
                            <img src="{% static 'images/hero.png' %}" class="card-img-top" alt="تصویر پیش‌فرض">
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
    </section>

    <section class="hero-split py-5">
        <div class="container-fluid px-lg-5">
            <div class="row d-flex flex-lg-row align-items-stretch">

                <div class="col-lg-3 d-flex justify-content-center align-items-center mt-4 mt-lg-0">

                    {% if product.is_full %}

                        <a class="register-btn my-2 disabled">
                            <span>تکمیل ظرفیت</span>
                        </a>

                    {% else %}

                        <a id="registerBtn" class="register-btn my-2">
                            <span>ثبت نام</span>
                            <i class="fa fa-arrow-left next-icon rtl"></i>
                        </a>
                    {% endif %}

                </div>

                <div class="col-lg-9">

                    <div class="course-schedule-form bg-white p-4 rounded shadow-sm h-100">
                        <h4 class="fw-bold mb-4">ثبت نام دوره</h4>

                        <!-- تعداد جلسات -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">تعداد جلسات در ماه:</label>
                            <div class="d-flex flex-wrap gap-2">
                                {% for x in session %}
                                    <button type="button" class="btn session-btn rounded-pill px-3"
                                            data-id="{{ x.id }}">{{ x.number }} جلسه
                                    </button>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- انتخاب روزهای هفته -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">روزهای برگزاری:</label>
                            <div id="days-container" class="d-flex flex-wrap gap-2">
                                {% for day in days %}
                                    <button
                                            type="button"
                                            class="btn day-btn rounded-pill px-3"
                                            data-id="{{ day.id }}"
                                            data-session-id="{{ day.session.id }}"
                                            data-price="{{ day.tuition }}"
                                            data-off="{{ day.off }}">
                                        {{ day.title }}
                                    </button>
                                {% endfor %}
                            </div>
                        </div>


                        <div class="mb-3">
                            <label class="form-label fw-bold">تاریخ شروع:</label>

                            <!-- توجه: این ردیف LTR است تا ستون‌ها دقیقاً طبق order بچینند -->
                            <div class="row g-3 align-items-start row-dir-fix">

                                <!-- تقویم: موبایل بالا / لپ‌تاپ راست -->
                                <div class="col-lg-8 order-1 order-lg-2 rtl-content">
                                    <div class="calendar-wrapper">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <button id="prevMonth" class="btn btn-cta" aria-label="ماه قبل">
                                                <i class="fa fa-chevron-right"></i>
                                            </button>
                                            <h5 id="monthTitle" class="text-center fw-bold m-0"></h5>
                                            <button id="nextMonth" class="btn btn-cta" aria-label="ماه بعد">
                                                <i class="fa fa-chevron-left"></i>
                                            </button>
                                        </div>

                                        <div class="calendar-grid text-center fw-bold border-bottom pb-2">
                                            <div>ش</div>
                                            <div>ی</div>
                                            <div>د</div>
                                            <div>س</div>
                                            <div>چ</div>
                                            <div>پ</div>
                                            <div>ج</div>
                                        </div>

                                        <div id="calendarDays" class="calendar-grid mt-2">
                                            <!-- لود از JS -->
                                        </div>
                                    </div>
                                </div>

                                <!-- کارت شهریه: موبایل پایین / لپ‌تاپ چپ -->
                                <!-- کارت شهریه: موبایل پایین / لپ‌تاپ چپ -->
                                <div class="col-lg-4 order-2 order-lg-1 rtl-content">
                                    <div class="card shadow-sm pricing-card">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-3 gap-2">
                                                <i class="fa fa-wallet"></i>
                                                <h6 class="fw-bold m-0">پرداختی</h6>
                                            </div>

                                            <div class="d-flex justify-content-between">
                                                <span class="text-muted">شهریه دوره</span>
                                                <strong id="uiPps">—</strong>  <!-- مجموع قبل از تخفیف -->
                                            </div>

                                            <div id="uiDiscountRow" class="d-flex justify-content-between mt-2">
                                                <span class="text-muted">تخفیف</span>
                                                <strong id="uiDiscount">—</strong>
                                            </div>

                                            <hr class="my-3">

                                            <div class="d-flex justify-content-between align-items-baseline">
                                                <span class="fw-bold">مبلغ نهایی</span>
                                                <strong id="uiTotal" class="fs-5 text-success">—</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

    </section>

    <section class="course-description py-5">
        <div class="container px-lg-5">
            <h4 class="fw-bold mb-4">توضیحات دوره</h4>

            <div class="description-box p-4 shadow-sm rounded">
                {% autoescape off %}
                    {{ product.description|linebreaksbr }}
                {% endautoescape %}
            </div>
        </div>
    </section>


    <script>
        let sessionId = 0;
        let dayId = 0;

        // همه روزها رو اول مخفی می‌کنیم
        document.querySelectorAll('.day-btn').forEach(day => {
            day.style.display = 'none';
        });

        // لیسنر کلیک روی روزها
        document.querySelectorAll('.day-btn').forEach(day => {
            day.addEventListener('click', () => {
                // فقط یکی انتخاب بشه
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                day.classList.add('active');
                dayId = day.getAttribute("data-id");

                // قیمت و تخفیف رو بخون
                const price = parseFloat(day.dataset.price || 0);
                const off = parseFloat(day.dataset.off || 0);

                // محاسبه تخفیف (فرض: off درصدی هست. اگر حالت دیگه داری تغییر بده)
                const discount = price * (off / 100);
                const finalPrice = price - discount;

                // نمایش توی کارت
                document.getElementById('uiPps').textContent = new Intl.NumberFormat('fa-IR').format(price) + ' تومان';
                document.getElementById('uiDiscount').textContent = discount > 0
                    ? '− ' + new Intl.NumberFormat('fa-IR').format(discount) + ' تومان'
                    : '—';
                document.getElementById('uiTotal').textContent = new Intl.NumberFormat('fa-IR').format(finalPrice) + ' تومان';

                // اگر می‌خوای ردیف تخفیف مخفی/نمایش بشه
                const row = document.getElementById('uiDiscountRow');
                if (discount > 0) {
                    row.classList.remove('d-none');
                } else {
                    row.classList.add('d-none');
                }
            });
        });

        // لیسنر کلیک روی جلسات
        document.querySelectorAll('.session-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // تغییر استایل انتخاب جلسه
                document.querySelectorAll('.session-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sessionId = btn.getAttribute("data-id");

                // ریست انتخاب روز و پاک‌کردن مقادیر کارت
                dayId = 0;
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('uiPps').textContent = '—';
                document.getElementById('uiDiscount').textContent = '—';
                document.getElementById('uiTotal').textContent = '—';
                document.getElementById('uiDiscountRow').classList.add('d-none');

                // نمایش روزهای مرتبط با جلسه انتخاب‌شده
                document.querySelectorAll('.day-btn').forEach(day => {
                    day.style.display = (day.getAttribute('data-session-id') === sessionId)
                        ? 'inline-block'
                        : 'none';
                });
            });
        });
    </script>



    <script>
        const apiBase = '/calendar'; // فرض کن آدرس API اینه
        let currentMonthId = null;
        let currentDayId = null;


        function loadMonth(monthId) {
            fetch(`${apiBase}/months/${monthId}/`)
                .then(res => res.json())
                .then(month => {
                    currentMonthId = month.id;
                    document.getElementById("monthTitle").innerText = `${month.name} ${month.year.number}`;

                    const daysContainer = document.getElementById("calendarDays");
                    daysContainer.innerHTML = "";

                    const startIndex = month.start_weekday; // 0=شنبه ... 6=جمعه

                    for (let i = 0; i < startIndex; i++) {
                            daysContainer.innerHTML += `<div class="col calendar-day empty disabled"></div>`;

                    }

                    month.days.forEach(day => {
                        const classes = ["calendar-day"];
                        if (day.holiday) classes.push("holiday");
                        if (day.today) classes.push("today");

                        daysContainer.innerHTML += `
      <div class="${classes.join(" ")}" data-id="${day.id}" title="${day.description || ''}">
        ${day.number}
      </div>`;
                    });

                });
        }

        // Navigation
        document.getElementById("prevMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/prev/`).then(res => res.json()).then(m => loadMonth(m.id));
        });
        document.getElementById("nextMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/next/`).then(res => res.json()).then(m => loadMonth(m.id));
        });

        // First load
        window.onload = () => {
            fetch(`${apiBase}/months/current/`).then(res => res.json()).then(m => loadMonth(m.id));
        };


        document.addEventListener('click', function (e) {
            const dayEl = e.target.closest('.calendar-day');
            if (dayEl) {
                // اول همه روزها از حالت انتخابی درمیاد
                document.querySelectorAll('.calendar-day').forEach(el => {
                    el.classList.remove('selected-day');
                });

                // فقط همونی که کلیک شد انتخاب میشه
                dayEl.classList.add('selected-day');
            }
        });

        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("calendar-day") && !e.target.classList.contains("holiday") && !e.target.classList.contains("past")) {
                document.querySelectorAll(".calendar-day").forEach(d => d.classList.remove("selected-day"));
                e.target.classList.add("selected-day");

                currentDayId = e.target.getAttribute("data-id");  // ✅ آیدی روز تقویم
            }
        });


    </script>


    <script>

        let course = "{{ product.id }}";

        document.addEventListener("DOMContentLoaded", function () {

            document.getElementById("registerBtn").addEventListener("click", function (event) {
                event.preventDefault(); // جلوی رفتن به لینک رو می‌گیره

                registerUser(); // 👈 مثلا یه فانکشنی که تعریف می‌کنی
            });

            function registerUser() {
                if (sessionId === 0) {
                    alert("لطفا تعداد جلسات در ماه انتخاب کنید");
                } else if (dayId === 0) {
                    alert("لطفا روز های برگزاری در هفته را انتخاب کنید");
                } else if (currentDayId === null) {
                    alert("لطفا تاریخ شروع دوره رو انتخاب کنید");
                } else {
                    window.location.assign(`/product/payment/${course}/${sessionId}/${dayId}/${currentDayId}`);
                }
            }

        });

    </script>


{% endblock %}
