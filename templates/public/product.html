{% extends 'public/base.html' %}
{% load static %}

{% block title %}{{ product.title }} | PowerGrow{% endblock %}


{% block content %}
    <section class="hero-split py-5">
        <div class="container-fluid px-lg-5">
            <div class="row g-5 align-items-stretch">

                <!-- Ù…ØªÙ† Ø³Ù…Øª Ø±Ø§Ø³Øª -->
                <div class="col-lg-6 d-flex">
                    <div class="ground-box text-white rounded p-4 w-100 d-flex flex-column justify-content-center">
                        <h2 class="fw-bold mb-4">{{ product.title }}</h2>

                        <div class="d-flex flex-column gap-4">

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-calendar-check fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</h5>
                                    <p class="mb-0 small text-white ">
                                        {% if product.type == "public" %}
                                            Ø¹Ù…ÙˆÙ…ÛŒ
                                        {% elif product.type == "private" %}
                                            Ø®ØµÙˆØµÛŒ
                                        {% elif product.type == "semi_private" %}
                                            Ù†ÛŒÙ…Ù‡ Ø®ØµÙˆØµÛŒ
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-clock fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">Ø²Ù…Ø§Ù† Ø¯ÙˆØ±Ù‡</h5>
                                    <p class="mb-0 small text-white ">{{ product.time }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-calendar-check fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">Ø¬Ù†Ø³Ø¨Øª Ø¯ÙˆØ±Ù‡</h5>
                                    <p class="mb-0 small text-white ">
                                        {% if product.gender == "male" %}
                                            Ø¢Ù‚Ø§ÛŒØ§Ù†
                                        {% elif product.gender == "female" %}
                                            Ø¨Ø§Ù†ÙˆØ§Ù†
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-user-tie fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">Ù…Ø±Ø¨ÛŒ</h5>
                                    <p class="mb-0 small text-white ">{{ product.name }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-users fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">Ø¸Ø±ÙÛŒØª Ø¯ÙˆØ±Ù‡</h5>
                                    <p class="mb-0 small text-white ">{{ product.capacity }}</p>
                                </div>
                            </div>

                            <div class="d-flex gap-3 align-items-start">
                                <i class="fa fa-money-bill-wave fa-2x"></i>
                                <div>
                                    <h5 class="mb-1">Ø´Ù‡Ø±ÛŒÙ‡</h5>
                                    <p class="mb-0 small text-white ">-</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Ø¹Ú©Ø³ Ø³Ù…Øª Ú†Ù¾ -->
                <div class="col-lg-6 d-flex">
                    <div class="img-wrapper w-100 d-flex align-items-center justify-content-center position-relative">
                        {% if product.previous %}
                            <div class="ribbon"><span class="bg-success">Ù¾ÛŒØ´ Ø«Ø¨Øª â€ŒÙ†Ø§Ù…</span></div>
                        {% elif product.is_full %}
                            <div class="ribbon"><span class="bg-danger">ØªÚ©Ù…ÛŒÙ„ Ø¸Ø±ÙÛŒØª</span></div>
                        {% endif %}
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ø¨Ø§Ù†ÙˆØ§Ù†" class="img-fluid rounded shadow">
                        {% else %}
                            <img src="{% static 'images/hero.png' %}" class="card-img-top" alt="ØªØµÙˆÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶">
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
    </section>

    <section class="hero-split py-5">
        <div class="container-fluid px-lg-5">
            <div class="row d-flex flex-lg-row align-items-stretch">

                <div class="col-lg-3 d-flex justify-content-center align-items-center mt-4 mt-lg-0">

                    {% if product.is_full %}

                        <a class="register-btn my-2 disabled">
                            <span>ØªÚ©Ù…ÛŒÙ„ Ø¸Ø±ÙÛŒØª</span>
                        </a>

                    {% else %}

                        <a id="registerBtn" class="register-btn my-2">
                            <span>Ø«Ø¨Øª Ù†Ø§Ù…</span>
                            <i class="fa fa-arrow-left next-icon rtl"></i>
                        </a>
                    {% endif %}

                </div>

                <div class="col-lg-9">

                    <div class="course-schedule-form bg-white p-4 rounded shadow-sm h-100">
                        <h4 class="fw-bold mb-4">Ø«Ø¨Øª Ù†Ø§Ù… Ø¯ÙˆØ±Ù‡</h4>

                        <!-- ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ø§Øª -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ø§Øª Ø¯Ø± Ù…Ø§Ù‡:</label>
                            <div class="d-flex flex-wrap gap-2">
                                {% for x in session %}
                                    <button type="button" class="btn session-btn rounded-pill px-3"
                                            data-id="{{ x.id }}">{{ x.number }} Ø¬Ù„Ø³Ù‡
                                    </button>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø±Ú¯Ø²Ø§Ø±ÛŒ:</label>
                            <div id="days-container" class="d-flex flex-wrap gap-2">
                                {% for day in days %}
                                    <button
                                            type="button"
                                            class="btn day-btn rounded-pill px-3"
                                            data-id="{{ day.id }}"
                                            data-session-id="{{ day.session.id }}"
                                            data-price="{{ day.tuition }}"
                                            data-off="{{ day.off }}">
                                        {{ day.title }}
                                    </button>
                                {% endfor %}
                            </div>
                        </div>


                        <div class="mb-3">
                            <label class="form-label fw-bold">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</label>

                            <!-- ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ LTR Ø§Ø³Øª ØªØ§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø·Ø¨Ù‚ order Ø¨Ú†ÛŒÙ†Ù†Ø¯ -->
                            <div class="row g-3 align-items-start row-dir-fix">

                                <!-- ØªÙ‚ÙˆÛŒÙ…: Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§Ù„Ø§ / Ù„Ù¾â€ŒØªØ§Ù¾ Ø±Ø§Ø³Øª -->
                                <div class="col-lg-8 order-1 order-lg-2 rtl-content">
                                    <div class="calendar-wrapper">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <button id="prevMonth" class="btn btn-cta" aria-label="Ù…Ø§Ù‡ Ù‚Ø¨Ù„">
                                                <i class="fa fa-chevron-right"></i>
                                            </button>
                                            <h5 id="monthTitle" class="text-center fw-bold m-0"></h5>
                                            <button id="nextMonth" class="btn btn-cta" aria-label="Ù…Ø§Ù‡ Ø¨Ø¹Ø¯">
                                                <i class="fa fa-chevron-left"></i>
                                            </button>
                                        </div>

                                        <div class="calendar-grid text-center fw-bold border-bottom pb-2">
                                            <div>Ø´</div>
                                            <div>ÛŒ</div>
                                            <div>Ø¯</div>
                                            <div>Ø³</div>
                                            <div>Ú†</div>
                                            <div>Ù¾</div>
                                            <div>Ø¬</div>
                                        </div>

                                        <div id="calendarDays" class="calendar-grid mt-2">
                                            <!-- Ù„ÙˆØ¯ Ø§Ø² JS -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Ú©Ø§Ø±Øª Ø´Ù‡Ø±ÛŒÙ‡: Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù¾Ø§ÛŒÛŒÙ† / Ù„Ù¾â€ŒØªØ§Ù¾ Ú†Ù¾ -->
                                <!-- Ú©Ø§Ø±Øª Ø´Ù‡Ø±ÛŒÙ‡: Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù¾Ø§ÛŒÛŒÙ† / Ù„Ù¾â€ŒØªØ§Ù¾ Ú†Ù¾ -->
                                <div class="col-lg-4 order-2 order-lg-1 rtl-content">
                                    <div class="card shadow-sm pricing-card">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-3 gap-2">
                                                <i class="fa fa-wallet"></i>
                                                <h6 class="fw-bold m-0">Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</h6>
                                            </div>

                                            <div class="d-flex justify-content-between">
                                                <span class="text-muted">Ø´Ù‡Ø±ÛŒÙ‡ Ø¯ÙˆØ±Ù‡</span>
                                                <strong id="uiPps">â€”</strong>  <!-- Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ø² ØªØ®ÙÛŒÙ -->
                                            </div>

                                            <div id="uiDiscountRow" class="d-flex justify-content-between mt-2">
                                                <span class="text-muted">ØªØ®ÙÛŒÙ</span>
                                                <strong id="uiDiscount">â€”</strong>
                                            </div>

                                            <hr class="my-3">

                                            <div class="d-flex justify-content-between align-items-baseline">
                                                <span class="fw-bold">Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ</span>
                                                <strong id="uiTotal" class="fs-5 text-success">â€”</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

    </section>

    <section class="course-description py-5">
        <div class="container px-lg-5">
            <h4 class="fw-bold mb-4">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¯ÙˆØ±Ù‡</h4>

            <div class="description-box p-4 shadow-sm rounded">
                {% autoescape off %}
                    {{ product.description|linebreaksbr }}
                {% endautoescape %}
            </div>
        </div>
    </section>


    <script>
        let sessionId = 0;
        let dayId = 0;

        // Ù‡Ù…Ù‡ Ø±ÙˆØ²Ù‡Ø§ Ø±Ùˆ Ø§ÙˆÙ„ Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        document.querySelectorAll('.day-btn').forEach(day => {
            day.style.display = 'none';
        });

        // Ù„ÛŒØ³Ù†Ø± Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø±ÙˆØ²Ù‡Ø§
        document.querySelectorAll('.day-btn').forEach(day => {
            day.addEventListener('click', () => {
                // ÙÙ‚Ø· ÛŒÚ©ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø´Ù‡
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                day.classList.add('active');
                dayId = day.getAttribute("data-id");

                // Ù‚ÛŒÙ…Øª Ùˆ ØªØ®ÙÛŒÙ Ø±Ùˆ Ø¨Ø®ÙˆÙ†
                const price = parseFloat(day.dataset.price || 0);
                const off = parseFloat(day.dataset.off || 0);

                // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ®ÙÛŒÙ (ÙØ±Ø¶: off Ø¯Ø±ØµØ¯ÛŒ Ù‡Ø³Øª. Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ø¯ÛŒÚ¯Ù‡ Ø¯Ø§Ø±ÛŒ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡)
                const discount = price * (off / 100);
                const finalPrice = price - discount;

                // Ù†Ù…Ø§ÛŒØ´ ØªÙˆÛŒ Ú©Ø§Ø±Øª
                document.getElementById('uiPps').textContent = new Intl.NumberFormat('fa-IR').format(price) + ' ØªÙˆÙ…Ø§Ù†';
                document.getElementById('uiDiscount').textContent = discount > 0
                    ? 'âˆ’ ' + new Intl.NumberFormat('fa-IR').format(discount) + ' ØªÙˆÙ…Ø§Ù†'
                    : 'â€”';
                document.getElementById('uiTotal').textContent = new Intl.NumberFormat('fa-IR').format(finalPrice) + ' ØªÙˆÙ…Ø§Ù†';

                // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø±Ø¯ÛŒÙ ØªØ®ÙÛŒÙ Ù…Ø®ÙÛŒ/Ù†Ù…Ø§ÛŒØ´ Ø¨Ø´Ù‡
                const row = document.getElementById('uiDiscountRow');
                if (discount > 0) {
                    row.classList.remove('d-none');
                } else {
                    row.classList.add('d-none');
                }
            });
        });

        // Ù„ÛŒØ³Ù†Ø± Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¬Ù„Ø³Ø§Øª
        document.querySelectorAll('.session-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ØªØºÛŒÛŒØ± Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø¬Ù„Ø³Ù‡
                document.querySelectorAll('.session-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sessionId = btn.getAttribute("data-id");

                // Ø±ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ² Ùˆ Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ù…Ù‚Ø§Ø¯ÛŒØ± Ú©Ø§Ø±Øª
                dayId = 0;
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('uiPps').textContent = 'â€”';
                document.getElementById('uiDiscount').textContent = 'â€”';
                document.getElementById('uiTotal').textContent = 'â€”';
                document.getElementById('uiDiscountRow').classList.add('d-none');

                // Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¬Ù„Ø³Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡
                document.querySelectorAll('.day-btn').forEach(day => {
                    day.style.display = (day.getAttribute('data-session-id') === sessionId)
                        ? 'inline-block'
                        : 'none';
                });
            });
        });
    </script>



    <script>
        const apiBase = '/calendar'; // ÙØ±Ø¶ Ú©Ù† Ø¢Ø¯Ø±Ø³ API Ø§ÛŒÙ†Ù‡
        let currentMonthId = null;
        let currentDayId = null;


        function loadMonth(monthId) {
            fetch(`${apiBase}/months/${monthId}/`)
                .then(res => res.json())
                .then(month => {
                    currentMonthId = month.id;
                    document.getElementById("monthTitle").innerText = `${month.name} ${month.year.number}`;

                    const daysContainer = document.getElementById("calendarDays");
                    daysContainer.innerHTML = "";

                    const startIndex = month.start_weekday; // 0=Ø´Ù†Ø¨Ù‡ ... 6=Ø¬Ù…Ø¹Ù‡

                    for (let i = 0; i < startIndex; i++) {
                            daysContainer.innerHTML += `<div class="col calendar-day empty disabled"></div>`;

                    }

                    month.days.forEach(day => {
                        const classes = ["calendar-day"];
                        if (day.holiday) classes.push("holiday");
                        if (day.today) classes.push("today");

                        daysContainer.innerHTML += `
      <div class="${classes.join(" ")}" data-id="${day.id}" title="${day.description || ''}">
        ${day.number}
      </div>`;
                    });

                });
        }

        // Navigation
        document.getElementById("prevMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/prev/`).then(res => res.json()).then(m => loadMonth(m.id));
        });
        document.getElementById("nextMonth").addEventListener("click", () => {
            fetch(`${apiBase}/months/${currentMonthId}/next/`).then(res => res.json()).then(m => loadMonth(m.id));
        });

        // First load
        window.onload = () => {
            fetch(`${apiBase}/months/current/`).then(res => res.json()).then(m => loadMonth(m.id));
        };


        document.addEventListener('click', function (e) {
            const dayEl = e.target.closest('.calendar-day');
            if (dayEl) {
                // Ø§ÙˆÙ„ Ù‡Ù…Ù‡ Ø±ÙˆØ²Ù‡Ø§ Ø§Ø² Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¯Ø±Ù…ÛŒØ§Ø¯
                document.querySelectorAll('.calendar-day').forEach(el => {
                    el.classList.remove('selected-day');
                });

                // ÙÙ‚Ø· Ù‡Ù…ÙˆÙ†ÛŒ Ú©Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒØ´Ù‡
                dayEl.classList.add('selected-day');
            }
        });

        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("calendar-day") && !e.target.classList.contains("holiday") && !e.target.classList.contains("past")) {
                document.querySelectorAll(".calendar-day").forEach(d => d.classList.remove("selected-day"));
                e.target.classList.add("selected-day");

                currentDayId = e.target.getAttribute("data-id");  // âœ… Ø¢ÛŒØ¯ÛŒ Ø±ÙˆØ² ØªÙ‚ÙˆÛŒÙ…
            }
        });


    </script>


    <script>

        let course = "{{ product.id }}";

        document.addEventListener("DOMContentLoaded", function () {

            document.getElementById("registerBtn").addEventListener("click", function (event) {
                event.preventDefault(); // Ø¬Ù„ÙˆÛŒ Ø±ÙØªÙ† Ø¨Ù‡ Ù„ÛŒÙ†Ú© Ø±Ùˆ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡

                registerUser(); // ğŸ‘ˆ Ù…Ø«Ù„Ø§ ÛŒÙ‡ ÙØ§Ù†Ú©Ø´Ù†ÛŒ Ú©Ù‡ ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ
            });

            function registerUser() {
                if (sessionId === 0) {
                    alert("Ù„Ø·ÙØ§ ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ø§Øª Ø¯Ø± Ù…Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
                } else if (dayId === 0) {
                    alert("Ù„Ø·ÙØ§ Ø±ÙˆØ² Ù‡Ø§ÛŒ Ø¨Ø±Ú¯Ø²Ø§Ø±ÛŒ Ø¯Ø± Ù‡ÙØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
                } else if (currentDayId === null) {
                    alert("Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ±Ù‡ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
                } else {
                    window.location.assign(`/product/payment/${course}/${sessionId}/${dayId}/${currentDayId}`);
                }
            }

        });

    </script>


{% endblock %}
